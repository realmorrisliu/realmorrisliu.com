---
import { SignedIn, SignedOut, UserButton, SignInButton } from "@clerk/astro/components";
import AuthStatus from "@/components/AuthStatus.astro";
import { cn } from "@/utils";
import PostHog from "../components/PostHog.astro";

export interface Props {
  title: string;
  description?: string;
  image?: string;
  imageAlt?: string;
  type?: string;
  publishedTime?: string;
  modifiedTime?: string;
  tags?: string[];
  readingTime?: number;
  lang?: string;
  alternateLanguages?: { lang: string; url: string }[];
}

const {
  title,
  description = "Morris Liu - Rust Developer & AI Infrastructure Engineer. Specializes in systems programming, AI tools, and open source projects. 7+ years building reliable, performant software.",
  image = "/og-image.png",
  imageAlt = "Morris Liu - Rust Developer & AI Infrastructure Engineer",
  type = "website",
  publishedTime,
  modifiedTime,
  tags = [],
  lang = "en",
  readingTime,
  alternateLanguages = [],
} = Astro.props;

const pathname = Astro.url.pathname.replace(/\.html$/, "").replace(/\/$/, "");
const canonicalURL = new URL(pathname, Astro.site || "https://realmorrisliu.com");
const imageURL = new URL(image, Astro.site || "https://realmorrisliu.com");

// Generate keywords
const keywords = [
  "Morris Liu",
  "Rust Developer",
  "Systems Programming",
  "AI Infrastructure Engineer",
  "Rust Programming",
  "Secret Management",
  "AI Tools",
  "Open Source",
  "Sealbox",
  "Kira AI",
  "TypeScript",
  "CAD Technology",
  "3D Visualization",
  "Performance Engineering",
  "Backend Systems",
  "EverXYZ",
  "UniXYZ",
  ...tags,
].join(", ");
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />

    <!-- Primary Meta Tags -->
    <title>{title}</title>
    <meta name="title" content={title} />
    <meta name="description" content={description} />
    <meta name="keywords" content={keywords} />
    <meta name="author" content="Morris Liu" />
    <meta name="robots" content="index, follow" />
    <link rel="canonical" href={canonicalURL} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content={type} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={imageURL} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content={imageAlt} />
    <meta property="og:site_name" content="Morris Liu" />
    <meta property="og:locale" content={lang === "zh" ? "zh_CN" : "en_US"} />

    {publishedTime && <meta property="article:published_time" content={publishedTime} />}
    {modifiedTime && <meta property="article:modified_time" content={modifiedTime} />}
    {type === "article" && <meta property="article:author" content="Morris Liu" />}
    {tags.map(tag => <meta property="article:tag" content={tag} />)}

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={canonicalURL} />
    <meta property="twitter:title" content={title} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={imageURL} />
    <meta property="twitter:image:alt" content={imageAlt} />
    <meta property="twitter:creator" content="@realmorrisliu" />

    <!-- Additional SEO -->
    <meta name="theme-color" content="#ffffff" />
    <meta name="msapplication-TileColor" content="#ffffff" />

    <!-- Hreflang for multilingual support -->
    {
      alternateLanguages.map(({ lang: hrefLang, url }) => (
        <link rel="alternate" hreflang={hrefLang} href={url} />
      ))
    }
    {
      alternateLanguages.length > 0 && (
        <link rel="alternate" hreflang={lang} href={canonicalURL.toString()} />
      )
    }

    <!-- RSS Feed -->
    <link rel="alternate" type="application/rss+xml" title="Morris Liu's Blog" href="/rss.xml" />

    <!-- Web App Manifest -->
    <link rel="manifest" href="/manifest.json" />

    <!-- Sitemap -->
    <link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap-index.xml" />

    <!-- Critical CSS inline would go here for above-the-fold content -->
    <!-- Fonts are loaded via CSS imports in global.css for better caching -->

    <!-- JSON-LD Schema -->
    <script
      type="application/ld+json"
      is:inline
      set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": type === "article" ? "BlogPosting" : "Person",
        ...(type === "article"
          ? {
              headline: title,
              description: description,
              image: imageURL.toString(),
              author: {
                "@type": "Person",
                name: "Morris Liu",
                url: "https://realmorrisliu.com",
                sameAs: ["https://github.com/realmorrisliu", "https://twitter.com/realmorrisliu"],
              },
              publisher: {
                "@type": "Person",
                name: "Morris Liu",
                url: "https://realmorrisliu.com",
                logo: {
                  "@type": "ImageObject",
                  url: "https://realmorrisliu.com/favicon.svg",
                },
              },
              datePublished: publishedTime,
              dateModified: modifiedTime || publishedTime,
              mainEntityOfPage: {
                "@type": "WebPage",
                "@id": canonicalURL.toString(),
              },
              articleSection: "Technology",
              inLanguage: "en-US",
              keywords: tags.join(", "),
              potentialAction: {
                "@type": "ReadAction",
                target: canonicalURL.toString(),
              },
              ...(readingTime && {
                timeRequired: `PT${readingTime}M`,
              }),
            }
          : {
              name: "Morris Liu",
              alternateName: ["Morris", "Liu Morris"],
              description:
                "Senior Software Engineer & Former CTO with 7+ years experience in Rust systems programming and AI infrastructure. Creator of Sealbox and Kira open source projects.",
              url: "https://realmorrisliu.com",
              image: imageURL.toString(),
              sameAs: [
                "https://github.com/realmorrisliu",
                "https://twitter.com/realmorrisliu",
                "https://linkedin.com/in/realmorrisliu",
              ],
              jobTitle: "Senior Software Engineer & AI Infrastructure Architect",
              hasOccupation: {
                "@type": "Occupation",
                name: "Software Engineer",
                occupationalCategory: "15-1132.00",
                skills: [
                  "Rust Programming",
                  "AI Infrastructure",
                  "Systems Architecture",
                  "Technical Leadership",
                  "DevOps Security",
                ],
              },
              alumniOf: {
                "@type": "EducationalOrganization",
                name: "Engineering Excellence Program",
              },
              knowsAbout: [
                "Rust Systems Programming",
                "AI Infrastructure Architecture",
                "Zero-Trust Security",
                "Technical Leadership",
                "Startup Engineering",
                "Open Source Development",
                "DevOps Best Practices",
                "Enterprise Software Design",
              ],
              makesOffer: {
                "@type": "Offer",
                itemOffered: {
                  "@type": "Service",
                  name: "Technical Consulting & Architecture Review",
                },
              },
            }),
      })}
    />

    <PostHog />
  </head>
  <body
    class={cn(
      "m-0 min-h-full w-full",
      "font-sans font-normal leading-relaxed text-text-primary bg-background antialiased"
    )}
  >
    <slot />
    <AuthStatus />
  </body>
</html>
