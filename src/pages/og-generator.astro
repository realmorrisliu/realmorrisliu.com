---
import Layout from "../layouts/Layout.astro";
import FooterSignature from "../components/FooterSignature.astro";
import Link from "../components/Link.astro";
import Button from "../components/Button.astro";
import "../styles/global.css";
---

<Layout
  title="OG Image Generator - Morris Liu"
  description="A simple tool to generate social media preview images for your content."
>
  <!-- ç«‹å³æ‰§è¡Œè„šæœ¬ï¼Œé¿å…é»‘å±é—ªçƒ -->
  <script is:inline>
    (function() {
      const STORAGE_KEY = "og-generator-visited";
      const hasVisited = localStorage.getItem(STORAGE_KEY);
      
      if (!hasVisited) {
        // é¦–æ¬¡è®¿é—®ï¼Œæ˜¾ç¤ºåŠ¨ç”»
        const style = document.createElement('style');
        style.textContent = '#terminal-boot { display: block !important; }';
        document.head.appendChild(style);
      }
    })();
  </script>
  <!-- ç»ˆç«¯å¯åŠ¨åŠ¨ç”» -->
  <div
    id="terminal-boot"
    class="fixed inset-0 z-50 overflow-hidden bg-black font-mono text-green-400"
    style="display: none;"
  >
    <div class="h-full p-8">
      <div id="ascii-logo" class="mb-8 mt-16 text-sm leading-tight opacity-0">
        <div>&nbsp;â–ˆâ–ˆâ–ˆâ•—&nbsp;&nbsp;&nbsp;â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>
        <div>&nbsp;â–ˆâ–ˆâ–ˆâ–ˆâ•—&nbsp;â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>
        <div>&nbsp;â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>
        <div>&nbsp;â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>
        <div>&nbsp;â–ˆâ–ˆâ•‘&nbsp;â•šâ•â•&nbsp;â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—</div>
        <div>&nbsp;â•šâ•â•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;â•šâ•â•â•šâ•â•â•â•â•â•â•</div>
      </div>

      <div id="boot-sequence" class="text-sm opacity-0">
        <div id="line1" class="mb-2"></div>
        <div id="line2" class="mb-2"></div>
        <div id="line3" class="mb-2 text-yellow-400"></div>
        <div id="line4" class="mb-2"></div>
        <div id="line5" class="mb-4"></div>
        <div id="line6" class="mb-4 text-gray-400">
          <span id="continue-text"></span>
          <span id="countdown" class="ml-2 inline-block w-8 text-left text-green-300"></span>
        </div>
      </div>
    </div>

    <div class="absolute right-4 bottom-4 text-xs text-gray-500">
      <kbd>ESC</kbd> to skip animation
    </div>
  </div>
  <div class="mx-auto max-w-2xl px-6 py-16">
    <header class="mb-16">
      <h1 class="mb-6 font-serif text-4xl leading-tight">OG Image Generator</h1>
      <p class="mb-6 text-base leading-relaxed text-gray-700">
        A simple tool to create social media preview images. Click on any text below to edit, then
        right-click the preview to save your image.
      </p>
      <p class="text-sm text-gray-500">
        Dimensions: 1200Ã—630px (standard for Twitter, LinkedIn, Facebook)
      </p>
    </header>

    <!-- Preview Container -->
    <div class="mb-8">
      <div id="ogContainer" class="relative h-[315px] w-[600px] border border-gray-300 bg-white">
        <div class="absolute top-1/2 left-10 -translate-y-1/2 font-mono leading-relaxed">
          <div class="mb-1 text-xs text-gray-500">$ whoami</div>
          <div class="mb-8 text-sm text-black">
            <span
              contenteditable="true"
              class="editable-text px-1 focus:bg-gray-50 focus:ring-1 focus:ring-gray-200 focus:outline-none"
              data-original="Morris Liu">Morris Liu</span
            >
          </div>

          <div class="mb-1 text-xs text-gray-500">$ echo $PASSION</div>
          <div class="text-xs text-gray-700">
            <span
              contenteditable="true"
              class="editable-text px-1 focus:bg-gray-50 focus:ring-1 focus:ring-gray-200 focus:outline-none"
              data-original="Building tools that matter">Building tools that matter</span
            >
          </div>
        </div>
      </div>
    </div>

    <!-- Controls -->
    <div class="mb-16 flex flex-wrap gap-4">
      <Button variant="primary" id="generateBtn"> Generate full size â†’ </Button>
      <Button variant="secondary" id="resetBtn"> Reset to defaults </Button>
    </div>

    <!-- Usage Instructions -->
    <section class="mb-16">
      <h2 class="mb-4 font-serif text-2xl leading-tight">How to use</h2>
      <ul class="grid gap-2 text-sm text-gray-700">
        <li>First, click on any text in the preview to edit it</li>
        <li>Then customize your name and tagline</li>
        <li>Next, click "Generate full size" to open the 1200Ã—630 version</li>
        <li>Finally, right-click and save your image</li>
      </ul>
    </section>

    <!-- Inspiration -->
    <section class="mb-16">
      <h3 class="mb-4 font-serif text-xl leading-tight">Some tagline ideas</h3>
      <ul class="grid gap-2 text-sm text-gray-700">
        <li class="tagline-suggestion cursor-pointer hover:underline">
          Building tools that spark joy
        </li>
        <li class="tagline-suggestion cursor-pointer hover:underline">
          Crafting software, one commit at a time
        </li>
        <li class="tagline-suggestion cursor-pointer hover:underline">Turning ideas into code</li>
        <li class="tagline-suggestion cursor-pointer hover:underline">
          Engineering elegant solutions
        </li>
        <li class="tagline-suggestion cursor-pointer hover:underline">
          Code, coffee, and curiosity
        </li>
        <li class="tagline-suggestion cursor-pointer hover:underline">
          Building the tools I wish I had
        </li>
      </ul>
    </section>

    <FooterSignature>
      <nav>
        <Link href="/" class="text-sm">â† Back to main page</Link>
      </nav>
    </FooterSignature>
  </div>

  <style>
    /* ç»ˆç«¯å¯åŠ¨åŠ¨ç”»æ ·å¼ */
    @keyframes typewriter {
      from {
        width: 0;
      }
      to {
        width: 100%;
      }
    }

    @keyframes blink {
      from,
      to {
        opacity: 1;
      }
      50% {
        opacity: 0;
      }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .typing-line::after {
      content: "";
      border-right: 2px solid #22c55e;
      animation: blink 1s infinite;
    }

    .typing-done::after {
      display: none;
    }

    #terminal-boot.fade-out {
      opacity: 0;
      transition: opacity 0.5s ease-out;
      pointer-events: none;
    }

    /* ASCII logo æ¸å…¥æ•ˆæœ */
    #ascii-logo.show {
      opacity: 1;
      animation: fadeInUp 1s ease-out;
    }

    #boot-sequence.show {
      opacity: 1;
    }
  </style>

  <script>
    import { getElementText } from "../scripts/og-utils";

    // ç»ˆç«¯å¯åŠ¨åŠ¨ç”»æ§åˆ¶
    document.addEventListener("DOMContentLoaded", () => {
      const STORAGE_KEY = "og-generator-visited";
      const terminalBoot = document.getElementById("terminal-boot");
      const asciiLogo = document.getElementById("ascii-logo");
      const bootSequence = document.getElementById("boot-sequence");

      // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
      if (!terminalBoot || !asciiLogo || !bootSequence) return;

      // æ£€æŸ¥æ˜¯å¦é¦–æ¬¡è®¿é—®
      const hasVisited = localStorage.getItem(STORAGE_KEY);

      if (hasVisited) {
        // éé¦–æ¬¡è®¿é—®ï¼Œç¡®ä¿åŠ¨ç”»éšè—ï¼ˆè™½ç„¶åº”è¯¥å·²ç»è¢«å¤´éƒ¨è„šæœ¬å¤„ç†äº†ï¼‰
        return;
      }

      // é¦–æ¬¡è®¿é—®ï¼Œæ’­æ”¾å¯åŠ¨åŠ¨ç”»
      let animationPhase = 0;
      let isSkipped = false;

      function skipAnimation() {
        if (isSkipped) return;
        isSkipped = true;
        localStorage.setItem(STORAGE_KEY, "true");
        terminalBoot.classList.add("fade-out");
        setTimeout(() => {
          terminalBoot.style.display = "none";
        }, 500);
      }

      function startAnimation() {
        // Phase 1: æ˜¾ç¤º ASCII logo
        setTimeout(() => {
          if (isSkipped) return;
          asciiLogo.classList.add("show");
        }, 500);

        // Phase 2: æ˜¾ç¤ºå¯åŠ¨åºåˆ—
        setTimeout(() => {
          if (isSkipped) return;
          bootSequence.classList.add("show");
          typeSequence();
        }, 1500);
      }

      function typeSequence() {
        const lines = [
          { id: "line1", text: "Morris Liu Terminal v1.0" },
          { id: "line2", text: "System initialized..." },
          { id: "line3", text: "ğŸ‰ Congratulations! You found the easter egg!" },
          { id: "line4", text: "Loading personal workspace..." },
          { id: "line5", text: "Welcome to the OG Generator." },
          { id: "continue-text", text: "Press any key to continue..." },
        ];
        let currentLineIndex = 0;

        function typeLine() {
          if (isSkipped || currentLineIndex >= lines.length) {
            // åŠ¨ç”»å®Œæˆï¼Œå¼€å§‹å€’è®¡æ—¶
            startCountdown();
            return;
          }

          const currentLine = lines[currentLineIndex];
          const lineElement = document.getElementById(currentLine.id);
          if (!lineElement) {
            currentLineIndex++;
            setTimeout(typeLine, 100);
            return;
          }

          // æ¸…ç©ºå…ƒç´ å†…å®¹ï¼Œå¼€å§‹æ‰“å­—
          lineElement.textContent = "";
          lineElement.classList.add("typing-line");

          let charIndex = 0;
          function typeChar() {
            if (isSkipped) return;

            if (charIndex < currentLine.text.length) {
              lineElement.textContent += currentLine.text[charIndex];
              charIndex++;
              setTimeout(typeChar, 50); // æ¯ä¸ªå­—ç¬¦50msé—´éš”
            } else {
              // å½“å‰è¡Œæ‰“å­—å®Œæˆ
              lineElement.classList.remove("typing-line");
              lineElement.classList.add("typing-done");
              currentLineIndex++;
              setTimeout(typeLine, 500); // è¡Œä¸è¡Œä¹‹é—´500msé—´éš”
            }
          }

          typeChar();
        }

        typeLine();
      }

      function startCountdown() {
        const countdownElement = document.getElementById("countdown");
        if (!countdownElement) return;

        let countdown = 4; // ä»4å¼€å§‹ï¼Œç«‹å³æ˜¾ç¤º3

        // ç«‹å³å¼€å§‹å€’è®¡æ—¶ï¼Œé¿å…å¡é¡¿æ„Ÿ
        const countdownInterval = setInterval(() => {
          if (isSkipped) {
            clearInterval(countdownInterval);
            return;
          }

          countdown--;
          if (countdown > 0) {
            countdownElement.textContent = `(${countdown})`;
          } else {
            clearInterval(countdownInterval);
            skipAnimation();
          }
        }, 1000);
      }

      // é”®ç›˜äº‹ä»¶ç›‘å¬ - ä»»æ„é”®è·³è¿‡
      function handleKeydown(e) {
        skipAnimation();
        document.removeEventListener("keydown", handleKeydown);
      }

      // é¼ æ ‡ç‚¹å‡»è·³è¿‡
      function handleClick() {
        skipAnimation();
        terminalBoot.removeEventListener("click", handleClick);
      }

      document.addEventListener("keydown", handleKeydown);
      terminalBoot.addEventListener("click", handleClick);

      // å¼€å§‹åŠ¨ç”»
      startAnimation();
    });

    // ç”Ÿæˆå®Œæ•´å°ºå¯¸å›¾ç‰‡
    document.getElementById("generateBtn")?.addEventListener("click", () => {
      const name = encodeURIComponent(getElementText('[data-original="Morris Liu"]', "Morris Liu"));
      const passion = encodeURIComponent(
        getElementText('[data-original="Building tools that matter"]', "Building tools that matter")
      );

      window.location.href = `/og-preview?name=${name}&passion=${passion}`;
    });

    // é‡ç½®åŠŸèƒ½
    document.getElementById("resetBtn")?.addEventListener("click", () => {
      document.querySelectorAll(".editable-text").forEach(el => {
        if (!(el instanceof HTMLElement)) return;
        const original = el.getAttribute("data-original");
        if (original) el.textContent = original;
      });
    });

    // æ ‡è¯­å»ºè®®ç‚¹å‡»åŠŸèƒ½
    document.querySelectorAll(".tagline-suggestion").forEach(el => {
      if (!(el instanceof HTMLElement)) return;
      el.addEventListener("click", () => {
        const passionEl = document.querySelector('[data-original="Building tools that matter"]');
        if (passionEl instanceof HTMLElement) {
          passionEl.textContent = el.textContent;
        }
      });
    });

    // ä¸ºå¯ç¼–è¾‘æ–‡æœ¬æ·»åŠ é”®ç›˜äº‹ä»¶
    document.querySelectorAll(".editable-text").forEach(el => {
      if (!(el instanceof HTMLElement)) return;
      el.addEventListener("keydown", e => {
        if (e.key === "Enter") {
          e.preventDefault();
          el.blur();
        }
      });
    });
  </script>
</Layout>
