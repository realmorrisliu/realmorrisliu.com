---
import { Image } from "astro:assets";
import type { CollectionEntry } from "astro:content";

interface Props {
  photos: CollectionEntry<"moments">[];
}

const { photos } = Astro.props;

// Sort photos by date descending
const sortedPhotos = photos.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
---

<div class="columns-1 gap-6 space-y-6 md:columns-2 lg:gap-8 lg:space-y-8">
  {
    sortedPhotos.map((photo, index) => (
      <div
        class="group relative mb-6 cursor-zoom-in break-inside-avoid lg:mb-8"
        style={`animation: fade-up 0.6s ease-out ${index * 0.1}s backwards;`}
      >
        <div class="relative overflow-hidden bg-gray-100 shadow-sm transition-shadow duration-500 group-hover:shadow-xl">
          <Image
            src={photo.data.image}
            alt={photo.data.title}
            width={1200}
            quality={95}
            class="h-auto w-full transition-transform duration-700 ease-out group-hover:scale-[1.02]"
          />

          {/* Overlay Gradient */}
          <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 transition-opacity duration-500 group-hover:opacity-100" />

          {/* Hover Metadata */}
          <div class="absolute bottom-0 left-0 w-full translate-y-4 transform p-6 text-white opacity-0 transition-all duration-500 group-hover:translate-y-0 group-hover:opacity-100">
            <h3 class="mb-1 font-serif text-xl tracking-wide">{photo.data.title}</h3>
            <p class="font-mono text-sm text-xs tracking-wider text-white/80 uppercase">
              {photo.data.location}
            </p>
          </div>
        </div>

        {/* Hidden metadata for lightbox */}
        <div
          class="hidden"
          data-photo-data={JSON.stringify({
            src: photo.data.image.src,
            title: photo.data.title,
            location: photo.data.location,
            date: photo.data.date,
            camera: photo.data.camera,
            lens: photo.data.lens,
            iso: photo.data.iso,
            aperture: photo.data.aperture,
            shutterSpeed: photo.data.shutterSpeed,
            width: photo.data.image.width,
            height: photo.data.image.height,
          })}
        />
      </div>
    ))
  }
</div>

{/* Lightbox Container */}
<div
  id="lightbox"
  class="fixed inset-0 z-50 hidden bg-zinc-950/98 opacity-0 backdrop-blur-md transition-opacity duration-500"
>
  <button
    id="lightbox-close"
    class="absolute top-6 right-6 z-50 p-2 text-white/70 transition-colors duration-300 hover:text-white"
    aria-label="Close lightbox"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="32"
      height="32"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="1.5"
      stroke-linecap="round"
      stroke-linejoin="round"
      ><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg
    >
  </button>

  <div class="flex h-full w-full flex-col items-center justify-center p-4 md:p-12">
    <div class="relative flex max-h-[80vh] max-w-[95vw] items-center justify-center">
      <img
        id="lightbox-img"
        src=""
        alt=""
        class="max-h-[80vh] max-w-full object-contain shadow-2xl ring-1 ring-white/10 md:max-w-5xl"
      />
    </div>

    <div class="animate-fade-in mt-8 max-w-2xl text-center">
      <h3 id="lightbox-title" class="mb-3 font-serif text-2xl tracking-wide text-white md:text-3xl">
      </h3>
      <div class="flex flex-col items-center gap-2 font-mono text-sm tracking-tight text-zinc-400">
        <span id="lightbox-camera" class="text-zinc-300"></span>
        <div class="flex items-center gap-3 text-xs tracking-widest uppercase opacity-70">
          <span id="lightbox-settings"></span>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  @keyframes fade-up {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in {
    animation: fade-in 0.5s ease-out forwards;
  }

  @keyframes fade-in {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }
</style>

<script>
  function setupLightbox() {
    const lightbox = document.getElementById("lightbox");
    const lightboxImg = document.getElementById("lightbox-img") as HTMLImageElement;
    const lightboxTitle = document.getElementById("lightbox-title");
    const lightboxCamera = document.getElementById("lightbox-camera");
    const lightboxSettings = document.getElementById("lightbox-settings");
    const closeBtn = document.getElementById("lightbox-close");
    const photoCards = document.querySelectorAll(".group");

    console.log("Setting up lightbox for", photoCards.length, "photos");

    // Expose to window for debugging/external control
    (window as any).openLightbox = (data: any) => {
      console.log("Opening lightbox with data:", data);
      if (!lightbox || !lightboxImg) return;

      lightboxImg.src = data.src;
      lightboxImg.alt = data.title;
      if (lightboxTitle) lightboxTitle.textContent = data.title;

      const settings = [
        data.lens,
        data.aperture,
        data.shutterSpeed,
        data.iso ? `ISO ${data.iso}` : null,
      ]
        .filter(Boolean)
        .join(" Â· ");

      if (lightboxCamera) lightboxCamera.textContent = data.camera || "";
      if (lightboxSettings) lightboxSettings.textContent = settings;

      lightbox.classList.remove("hidden");
      requestAnimationFrame(() => {
        lightbox.classList.remove("opacity-0");
      });
      document.body.style.overflow = "hidden";
    };

    (window as any).closeLightbox = () => {
      if (!lightbox) return;
      lightbox.classList.add("opacity-0");
      setTimeout(() => {
        lightbox.classList.add("hidden");
        document.body.style.overflow = "";
      }, 500);
    };

    photoCards.forEach(card => {
      card.addEventListener("click", () => {
        console.log("Card clicked");
        const dataDiv = card.querySelector("[data-photo-data]");
        if (dataDiv) {
          const data = JSON.parse(dataDiv.getAttribute("data-photo-data") || "{}");
          (window as any).openLightbox(data);
        }
      });
    });

    closeBtn?.addEventListener("click", (window as any).closeLightbox);

    lightbox?.addEventListener("click", e => {
      if (e.target === lightbox || e.target === document.querySelector("#lightbox > div"))
        (window as any).closeLightbox();
    });

    document.addEventListener("keydown", e => {
      if (e.key === "Escape") (window as any).closeLightbox();
    });
  }

  // Run setup immediately
  setupLightbox();

  // Also run on astro:page-load if view transitions are ever added
  document.addEventListener("astro:page-load", setupLightbox);
</script>
